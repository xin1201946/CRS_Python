name: Build and Release CCRS

on:
  push:
    branches:
      - main  # ç›‘å¬ main åˆ†æ”¯çš„ push
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: æ£€æŸ¥ä»“åº“å†…å®¹
        run: dir


      - name: è®¾ç½® Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: å®‰è£… Nuitka åŠå…¶ä»–ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          python -m pip install nuitka

      - name: å®‰è£… CCRS_Library ä¾èµ–
        run: python -m pip install ./CCRS_Library-2.0.5.14-py3-none-any.whl

      - name: å®‰è£…é¡¹ç›®ä¾èµ–
        run: |
          python -m pip install -r requirements.txt

      - name: ç¼–è¯‘é¡¹ç›®
        run: |
          python -m nuitka ;
            --standalone ;
            --follow-imports ;
            --nofollow-import-to=IPython ;
            --output-dir=dist ;
            --enable-plugin=no-qt ;
            --include-module=ultralytics ;
            --include-module=CCRS_Library ;
            --include-module=tensorflow ;
            --module-parameter=torch-disable-jit=no ;
            --windows-icon-from-ico=CCRS.ico ; 
            --windows-product-name="CCRS" ;
            --windows-file-description="Casting Char Recognition System" ;
            --product-version=2.0.5 ;
            --file-version=2.0.5 ;
            --output-filename=CCRS ;
            main.py

      - name: å¤åˆ¶é¢å¤–ä¾èµ–
        run: |
          $SRC_DIR="C:\hostedtoolcache\windows\Python\3.11\x64\Lib\site-packages"
          $DST_DIR="dist\main.dist"
          foreach ($package in @("ultralytics", "CCRS_Library", "yolov5", "yolov5\models", "torch", "torchaudio", "torchgen", "torchvision")) {
              if (Test-Path "$SRC_DIR\$package") {
                  Write-Output "å¤åˆ¶ $package ..."
                  Copy-Item -Path "$SRC_DIR\$package" -Destination "$DST_DIR\$package" -Recurse -Force
              } else {
                  Write-Output "[è­¦å‘Š] æœªæ‰¾åˆ° $packageï¼Œè·³è¿‡å¤åˆ¶ï¼"
              }
          }
          
          if (Test-Path ".\getNum.py") {
              Copy-Item ".\getNum.py" "$DST_DIR\getNum.py" -Force
          }

          if (Test-Path ".\flask-dist") {
              Copy-Item ".\flask-dist" "$DST_DIR\flask-dist" -Recurse -Force
          }

      - name: æ‰“åŒ…æ„å»ºäº§ç‰©
        run: Compress-Archive -Path "dist\main.dist\*" -DestinationPath "CCRS_Build.zip"

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©ï¼ˆArtifactï¼‰
        uses: actions/upload-artifact@v4
        with:
          name: CCRS_Build
          path: CCRS_Build.zip
          retention-days: 7

  release:
    needs: build  # ä¾èµ– build ä»»åŠ¡
    runs-on: ubuntu-latest
    steps:
      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: CCRS_Build
          path: CCRS_Build

      - name: æ£€æŸ¥ Tag ç‰ˆæœ¬
        id: check_tag
        run: |
          TAG_NAME="${{ github.ref_name }}"
          if [[ "$TAG_NAME" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "RELEASE_TAG=$TAG_NAME" >> $GITHUB_ENV
            echo "å‘å¸ƒæ­£å¼ç‰ˆæœ¬: $TAG_NAME"
          else
            echo "RELEASE_TAG=latest" >> $GITHUB_ENV
            echo "æœªæ‰¾åˆ° Tagï¼Œå‘å¸ƒä¸º latest"
          fi

      - name: å‘å¸ƒ Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: CCRS Release ${{ env.RELEASE_TAG }}
          body: |
            ğŸš€ **æ–°ç‰ˆæœ¬å‘å¸ƒ**
            - è‡ªåŠ¨ç¼–è¯‘ & æ‰“åŒ…
            - Nuitka ç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶
            - ä¾èµ–åº“å·²æ‰“åŒ…ï¼Œæ— éœ€å•ç‹¬å®‰è£…
            åŸºäº CCRS å†…æ ¸ ${{ env.KERNEL_VERSION }} ç¼–è¯‘
            **âš  æ³¨æ„:** è¿è¡Œæ—¶ä»éœ€ `torch` å’Œ `tensorflow` çš„å…¼å®¹ DLL
          draft: false
          prerelease: false
          files: CCRS_Build/CCRS_Build.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
